<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Starlight Editor</title>

<!-- CodeMirror 6 core -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@6.0.1/dist/codemirror.css">
<script src="https://cdn.jsdelivr.net/npm/codemirror@6.0.1/dist/codemirror.js"></script>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
  :root {
    --sidebar-width: 250px;
    --tab-height: 32px;
    --editor-font: 'Fira Code', monospace;
  }

  body {
    margin: 0;
    font-family: var(--editor-font);
    height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: #1e1e1e;
    color: #d4d4d4;
  }

  #tabs {
    display: flex;
    height: var(--tab-height);
    background-color: #2d2d2d;
    border-bottom: 1px solid #444;
    overflow-x: auto;
  }

  .tab {
    display: flex;
    align-items: center;
    padding: 0 10px;
    cursor: pointer;
    white-space: nowrap;
  }

  .tab.active {
    background-color: #1e1e1e;
    border-bottom: 2px solid #007acc;
  }

  .tab i.dismiss {
    margin-left: 5px;
    cursor: pointer;
  }

  #main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  #sidebar {
    width: var(--sidebar-width);
    background-color: #252526;
    border-right: 1px solid #444;
    overflow-y: auto;
  }

  #sidebar ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  #sidebar li {
    padding: 4px 8px;
    display: flex;
    align-items: center;
    cursor: pointer;
  }

  #sidebar li:hover {
    background-color: #3e3e3e;
  }

  .folder {
    font-weight: bold;
  }

  .folder > i.fa-chevron-right {
    margin-right: 5px;
    transition: transform 0.2s ease;
  }

  .folder.expanded > i.fa-chevron-right {
    transform: rotate(90deg);
  }

  #editor-container {
    flex: 1;
    position: relative;
  }

  .CodeMirror {
    height: 100%;
    font-family: var(--editor-font);
    font-size: 14px;
    background-color: #1e1e1e;
    color: #d4d4d4;
  }

  button {
    background: #007acc;
    color: #fff;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    margin: 5px;
    border-radius: 3px;
  }
</style>
</head>
<body>

<div id="tabs"></div>
<div id="main">
  <div id="sidebar">
    <button id="select-folder">Select Folder</button>
    <ul id="file-tree"></ul>
  </div>
  <div id="editor-container"></div>
</div>

<script type="module">
import { EditorView, basicSetup } from "https://cdn.jsdelivr.net/npm/@codemirror/basic-setup@6.0.1/dist/index.js";
import { javascript } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@6.0.1/dist/index.js";

// Starlight keywords
const starlightKeywords=["let","sldeploy","if","else","while","for","break","continue","func","return","true","false","null","ask","define","import","from","as","async","await","new","in","do","track","start","race"];


// Custom Starlight syntax highlighting using CodeMirror
import {HighlightStyle, tags} from "https://cdn.jsdelivr.net/npm/@codemirror/language@6.0.1/dist/index.js";

const starlightHighlight = HighlightStyle.define([
  {tag: tags.keyword, color: "#569CD6"},
  {tag: tags.atom, color: "#C586C0"},
  {tag: tags.string, color: "#CE9178"},
  {tag: tags.number, color: "#B5CEA8"},
  {tag: tags.comment, color: "#6A9955"},
  {tag: tags.variableName, color: "#9CDCFE"},
  {tag: tags.function(tags.variableName), color: "#DCDCAA"}
]);

// Editor state
let editor = new EditorView({
  extensions: [basicSetup, javascript(), starlightHighlight],
  parent: document.getElementById("editor-container")
});

let openTabs = [];
let currentFolder = null;

// Folder selection
document.getElementById("select-folder").addEventListener("click", async () => {
  try {
    // File System Access API
    const folderHandle = await window.showDirectoryPicker();
    currentFolder = folderHandle;
    await loadFolder(folderHandle, document.getElementById("file-tree"));
  } catch(e) {
    console.error("Folder access denied:", e);
  }
});

// Recursively load folder
async function loadFolder(folderHandle, container) {
  container.innerHTML = "";
  for await (const [name, handle] of folderHandle.entries()) {
    const li = document.createElement("li");
    li.textContent = name;
    const icon = document.createElement("i");
    icon.className = handle.kind === "directory" ? "fas fa-folder" : "fas fa-file";
    li.prepend(icon);

    if (handle.kind === "directory") {
      li.classList.add("folder");
      const subList = document.createElement("ul");
      subList.style.display = "none";
      li.appendChild(subList);

      li.addEventListener("click", async (e) => {
        e.stopPropagation();
        const expanded = li.classList.toggle("expanded");
        subList.style.display = expanded ? "block" : "none";
        if (expanded && subList.childElementCount === 0) {
          await loadFolder(handle, subList);
        }
      });
    } else {
      li.addEventListener("click", async (e) => {
        e.stopPropagation();
        openFile(handle);
      });
    }

    container.appendChild(li);
  }
}

// Open file in a new tab
async function openFile(fileHandle) {
  const fileName = fileHandle.name;
  if (openTabs.some(tab => tab.name === fileName)) {
    switchTab(fileName);
    return;
  }

  const file = await fileHandle.getFile();
  const text = await file.text();

  openTabs.push({name: fileName, handle: fileHandle, content: text});
  addTab(fileName, text);
}

// Add tab at the top
function addTab(name, content) {
  const tabs = document.getElementById("tabs");
  const tab = document.createElement("div");
  tab.className = "tab active";
  tab.textContent = name;

  const dismiss = document.createElement("i");
  dismiss.className = "fas fa-times dismiss";
  dismiss.addEventListener("click", (e) => {
    e.stopPropagation();
    closeTab(name);
  });

  tab.appendChild(dismiss);
  tab.addEventListener("click", () => switchTab(name));

  // Deactivate other tabs
  document.querySelectorAll("#tabs .tab").forEach(t => t.classList.remove("active"));
  tabs.appendChild(tab);

  editor.dispatch({
    changes: {from:0, to:editor.state.doc.length, insert: content}
  });
}

// Switch active tab
function switchTab(name) {
  const tab = [...document.querySelectorAll("#tabs .tab")].find(t => t.textContent.includes(name));
  if (!tab) return;

  document.querySelectorAll("#tabs .tab").forEach(t => t.classList.remove("active"));
  tab.classList.add("active");

  const file = openTabs.find(f => f.name === name);
  if (file) {
    editor.dispatch({
      changes: {from:0, to:editor.state.doc.length, insert: file.content}
    });
  }
}

// Close tab
function closeTab(name) {
  openTabs = openTabs.filter(t => t.name !== name);
  const tab = [...document.querySelectorAll("#tabs .tab")].find(t => t.textContent.includes(name));
  if (tab) tab.remove();

  if (openTabs.length) switchTab(openTabs[0].name);
}

// Save file
async function saveCurrentFile() {
  const activeTab = document.querySelector("#tabs .tab.active");
  if (!activeTab) return;
  const fileName = activeTab.textContent.replace(/\sÃ—$/, "");
  const file = openTabs.find(f => f.name === fileName);
  if (!file) return;

  const writable = await file.handle.createWritable();
  await writable.write(editor.state.doc.toString());
  await writable.close();
  file.content = editor.state.doc.toString();
  alert("File saved!");
}

// Create file
async function createFile() {
  if (!currentFolder) return alert("Select a folder first");
  const fileName = prompt("Enter file name:");
  if (!fileName) return;
  const handle = await currentFolder.getFileHandle(fileName, { create: true });
  await loadFolder(currentFolder, document.getElementById("file-tree"));
}

// Buttons
const btnSave = document.createElement("button");
btnSave.textContent = "Save";
btnSave.addEventListener("click", saveCurrentFile);
document.body.appendChild(btnSave);

const btnCreate = document.createElement("button");
btnCreate.textContent = "New File";
btnCreate.addEventListener("click", createFile);
document.body.appendChild(btnCreate);

</script>
</body>
</html>
