<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Starlight Editor</title>
<style>
  body { margin: 0; font-family: monospace; display: flex; height: 100vh; }
  #sidebar { width: 250px; background: #1e1e1e; color: #ccc; overflow-y: auto; padding: 10px; }
  #editor-container { flex: 1; display: flex; flex-direction: column; }
  #tabs { height: 35px; display: flex; background: #2d2d2d; }
  .tab { padding: 5px 10px; cursor: pointer; border-right: 1px solid #444; display: flex; align-items: center; }
  .tab.active { background: #1e1e1e; }
  .tab button { margin-left: 5px; background: none; border: none; color: #aaa; cursor: pointer; }
  #editor { flex: 1; background: #1e1e1e; color: #ccc; padding: 10px; overflow: auto; white-space: pre; outline: none; font-family: monospace; }
  .keyword { color: #569CD6; font-weight: bold; }
  .string { color: #CE9178; }
  .number { color: #B5CEA8; }
  .comment { color: #6A9955; font-style: italic; }
</style>
</head>
<body>
<div id="sidebar">
  <button id="openFolder">Open Folder</button>
  <div id="fileList"></div>
</div>

<div id="editor-container">
  <div id="tabs"></div>
  <div id="editor" contenteditable="true"></div>
  <button id="saveBtn">Save</button>
</div>

<script>
const starlightKeywords=["let","sldeploy","if","else","while","for","break","continue","func","return","true","false","null","ask","define","import","from","as","async","await","new","in","do","track","start","race"];

let files = {}; // {filename: {handle, content}}
let activeFile = null;

const editor = document.getElementById('editor');
const tabs = document.getElementById('tabs');
const fileList = document.getElementById('fileList');

function highlight(code) {
  // escape HTML
  code = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  // highlight comments
  code = code.replace(/(\/\/.*)/g, '<span class="comment">$1</span>');
  // highlight strings
  code = code.replace(/(["'`].*?["'`])/g, '<span class="string">$1</span>');
  // highlight numbers
  code = code.replace(/\b(\d+(\.\d+)?)\b/g, '<span class="number">$1</span>');
  // highlight keywords
  const kw = starlightKeywords.join("|");
  code = code.replace(new RegExp(`\\b(${kw})\\b`, "g"), '<span class="keyword">$1</span>');
  return code;
}

function openFile(handle, name) {
  files[name] = {handle, content: ''};
  activeFile = name;

  // read content
  handle.getFile().then(file => file.text()).then(text => {
    files[name].content = text;
    editor.innerHTML = highlight(text);
    renderTabs();
  });
}

function renderTabs() {
  tabs.innerHTML = '';
  Object.keys(files).forEach(name => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (name === activeFile ? ' active' : '');
    tab.innerHTML = name + '<button>&times;</button>';
    tab.onclick = () => { activeFile = name; editor.innerHTML = highlight(files[name].content); renderTabs(); };
    tab.querySelector('button').onclick = (e) => { e.stopPropagation(); delete files[name]; if(activeFile===name) activeFile=Object.keys(files)[0]||null; if(activeFile) editor.innerHTML = highlight(files[activeFile].content); renderTabs(); };
    tabs.appendChild(tab);
  });
}

editor.addEventListener('input', () => {
  if(activeFile) {
    const text = editor.innerText;
    files[activeFile].content = text;
    editor.innerHTML = highlight(text);
    // move cursor to end
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(editor);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
  }
});

document.getElementById('openFolder').onclick = async () => {
  const dirHandle = await window.showDirectoryPicker();
  fileList.innerHTML = '';
  for await (const [name, handle] of dirHandle.entries()) {
    const fileDiv = document.createElement('div');
    fileDiv.textContent = name;
    fileDiv.style.cursor = 'pointer';
    fileDiv.onclick = () => openFile(handle, name);
    fileList.appendChild(fileDiv);
  }
};

document.getElementById('saveBtn').onclick = async () => {
  if(!activeFile) return alert('No file open');
  const fileHandle = files[activeFile].handle;
  const writable = await fileHandle.createWritable();
  await writable.write(files[activeFile].content);
  await writable.close();
  alert('Saved!');
};
</script>
</body>
</html>
