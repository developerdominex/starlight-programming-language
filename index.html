<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Starlight Editor</title>

<!-- CodeMirror 6 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@6.0.1/dist/codemirror.min.css">
<script src="https://cdn.jsdelivr.net/npm/@codemirror/basic-setup@6.0.1/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@codemirror/view@6.0.1/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@codemirror/state@6.0.1/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@6.0.1/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@codemirror/highlight@6.0.1/dist/index.js"></script>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

<style>
  body { margin: 0; font-family: 'Fira Code', monospace; display: flex; height: 100vh; }
  #sidebar { width: 300px; background: #1e1e1e; color: #ccc; overflow-y: auto; padding: 10px; }
  #editor-container { flex: 1; display: flex; flex-direction: column; }
  #tabs { height: 40px; background: #2d2d2d; display: flex; align-items: center; overflow-x: auto; }
  .tab { padding: 5px 10px; margin-right: 2px; background: #3c3c3c; display: flex; align-items: center; cursor: pointer; }
  .tab.active { background: #007acc; color: white; }
  .tab i { margin-left: 5px; cursor: pointer; }
  #editor { flex: 1; }
  ul { list-style: none; padding-left: 0; }
  li { display: flex; align-items: center; cursor: pointer; padding: 2px 5px; }
  li i.folder { margin-right: 5px; }
  li i.file { margin-right: 5px; }
  li.collapsible > span { user-select: none; flex: 1; }
  li.collapsible > ul { display: none; margin-left: 15px; }
  li.collapsible.open > ul { display: block; }
  button { cursor: pointer; }
</style>
</head>
<body>

<div id="sidebar">
  <button id="select-folder">Select Folder</button>
  <ul id="file-tree"></ul>
</div>

<div id="editor-container">
  <div id="tabs"></div>
  <div id="editor"></div>
  <button id="save-btn" style="background:#007acc;color:white;border:none;height:40px;">Save</button>
</div>

<script type="module">
import {EditorView, basicSetup} from "https://cdn.jsdelivr.net/npm/@codemirror/basic-setup@6.0.1/dist/index.js";
import {EditorState} from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.0.1/dist/index.js";
import {javascript} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@6.0.1/dist/index.js";
import {HighlightStyle, tags} from "https://cdn.jsdelivr.net/npm/@codemirror/highlight@6.0.1/dist/index.js";

let folderHandle = null;
let openFiles = {};
let activeFile = null;

// Starlight syntax highlighting
const starlightHighlight = HighlightStyle.define([
  { tag: tags.keyword, color: '#dcdcaa' },
  { tag: tags.variableName, color: '#9cdcfe' },
  { tag: tags.comment, color: '#6a9955' },
  { tag: tags.string, color: '#ce9178' },
  { tag: tags.number, color: '#b5cea8' },
]);

const starlightLanguage = javascript({ keywords: ['var', 'let', 'const', 'if', 'else', 'while', 'for', 'break', 'continue', 'function', 'return', 'sldeploy'] });

const editor = new EditorView({
  state: EditorState.create({
    doc: '',
    extensions: [basicSetup, starlightLanguage, starlightHighlight]
  }),
  parent: document.getElementById('editor')
});

document.getElementById('select-folder').addEventListener('click', async () => {
  folderHandle = await window.showDirectoryPicker();
  loadFolder(folderHandle, document.getElementById('file-tree'));
});

// Recursively list files/folders
async function loadFolder(dirHandle, parentUl) {
  parentUl.innerHTML = '';
  for await (const [name, handle] of dirHandle.entries()) {
    const li = document.createElement('li');
    const icon = document.createElement('i');
    const span = document.createElement('span');
    span.textContent = name;

    if (handle.kind === 'directory') {
      icon.className = 'fas fa-folder folder';
      li.classList.add('collapsible');
      const ul = document.createElement('ul');
      li.appendChild(icon);
      li.appendChild(span);
      li.appendChild(ul);
      span.addEventListener('click', () => li.classList.toggle('open'));
      parentUl.appendChild(li);
      loadFolder(handle, ul);
    } else {
      icon.className = 'fas fa-file file';
      li.appendChild(icon);
      li.appendChild(span);
      span.addEventListener('click', async () => openFile(handle));
      parentUl.appendChild(li);
    }
  }
}

async function openFile(fileHandle) {
  const file = await fileHandle.getFile();
  const text = await file.text();
  if (openFiles[fileHandle.name]) {
    setActiveTab(fileHandle.name);
    return;
  }
  // Create tab
  const tab = document.createElement('div');
  tab.className = 'tab active';
  tab.textContent = fileHandle.name;
  const closeBtn = document.createElement('i');
  closeBtn.className = 'fas fa-times';
  closeBtn.onclick = () => closeTab(fileHandle.name);
  tab.appendChild(closeBtn);
  document.getElementById('tabs').appendChild(tab);

  openFiles[fileHandle.name] = { handle: fileHandle, tab, content: text };
  setActiveTab(fileHandle.name);
}

function setActiveTab(name) {
  activeFile = name;
  // Set editor content
  editor.dispatch({ changes: { from: 0, to: editor.state.doc.length, insert: openFiles[name].content } });
  // Highlight active tab
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  openFiles[name].tab.classList.add('active');
}

function closeTab(name) {
  openFiles[name].tab.remove();
  delete openFiles[name];
  if (activeFile === name) {
    const keys = Object.keys(openFiles);
    if (keys.length) setActiveTab(keys[0]);
    else {
      editor.dispatch({ changes: { from: 0, to: editor.state.doc.length, insert: '' } });
      activeFile = null;
    }
  }
}

document.getElementById('save-btn').addEventListener('click', async () => {
  if (!activeFile) return;
  const file = openFiles[activeFile];
  const writable = await file.handle.createWritable();
  await writable.write(editor.state.doc.toString());
  await writable.close();
  file.content = editor.state.doc.toString();
});

// Create new file
async function createFile(name) {
  if (!folderHandle) return alert('Select a folder first');
  const handle = await folderHandle.getFileHandle(name, { create: true });
  await openFile(handle);
}

</script>
</body>
</html>
